# Xendit Payment Provider for Medusa v2

A comprehensive payment provider plugin for Medusa v2 that integrates with [Xendit](https://www.xendit.co/), enabling merchants to accept payments from customers across Southeast Asia, particularly Indonesia.

## Features

- Integration with Xendit Payment Links API (v2/invoices)
- Hosted checkout page - customers complete payment on Xendit's secure platform
- Multiple payment methods supported by Xendit:
  - E-wallets (OVO, DANA, GoPay, LinkAja, ShopeePay, etc.)
  - Virtual Accounts (BCA, BNI, BRI, Mandiri, Permata, etc.)
  - QR Codes (QRIS)
  - Credit/Debit Cards
  - Retail Outlets (Alfamart, Indomaret)
  - Direct Debit
- Automatic webhook handling for payment status updates
- Secure webhook verification
- Comprehensive logging and error handling
- Multi-currency support
- Test mode with payment simulation for local development

## Installation

### 1. Install the Plugin

```bash
npm install xendit-medusa
# or
yarn add xendit-medusa
# or
pnpm add xendit-medusa
```

### 1.1 Build the Plugin (Local / Workspace Installations)

The package ships TypeScript source and a `.medusa` server bundle that's generated by the Medusa plugin build step. When you're developing locally with a monorepo or pnpm workspace, ensure the plugin is built so the Medusa app can load the compiled server files.

```bash
# Run the build for xendit-medusa only
pnpm -w --filter xendit-medusa build

# Or run workspace-wide builds
pnpm -w build
```

If you install `xendit-medusa` from npm, the `prepublishOnly` script will build the plugin automatically at publish time. For local development the package also contains `prepare` and `postinstall` scripts that run the build during install.

### 1.2 Quick Dev (Watch) Mode

When developing the plugin locally, you can run a watch mode that keeps server JS files compiled as you edit the TypeScript sources. Use the included `dev:watch` script in the plugin package:

```bash
# In a new terminal from repo root
pnpm -w --filter xendit-medusa dev:watch

# Start the Medusa app dev server (in another terminal)
cd apps/medusa-app
pnpm dev
```

This keeps `.medusa/server/src` updated with compiled JS and reloads the dev server.

### 2. Configure the Plugin

Add the Xendit payment provider to your `medusa-config.ts`:

```typescript
import { defineConfig } from "@medusajs/framework/utils";

export default defineConfig({
  // ... other config
  modules: [
    {
      resolve: "@medusajs/medusa/payment",
      options: {
        providers: [
          {
            resolve: "xendit-medusa/providers/xendit",
            id: "xendit",
            options: {
              api_key: process.env.XENDIT_SECRET_KEY,
              webhook_token: process.env.XENDIT_WEBHOOK_TOKEN, // Optional but recommended
              default_country: "ID", // Required: ISO 3166-1 alpha-2 country code
              test_mode: process.env.XENDIT_TEST_MODE === "true", // Optional: enables payment simulation
            },
          },
        ],
      },
    },
  ],
});
```

### 3. Add Environment Variables

Create or update your `.env` file:

```bash
# Required: Get from https://dashboard.xendit.co/settings/developers#api-keys
XENDIT_SECRET_KEY=xnd_development_your_secret_key_here

# Required for production (optional for development): Get from https://dashboard.xendit.co/settings/developers#webhooks
# STRONGLY RECOMMENDED by Xendit to prevent man-in-the-middle attacks and money loss incidents
# This is the "Callback Token" shown when you set your webhook URL
XENDIT_WEBHOOK_TOKEN=your_webhook_verification_token_here
```

### 4. Enable the Payment Provider

1. Start your Medusa backend:
   ```bash
   npm run dev
   ```

2. Open the Medusa Admin Dashboard
3. Go to **Settings** → **Regions**
4. Select or create a region
5. In the **Payment Providers** section, enable **Xendit**

## Configuration Options

| Option | Type | Required | Default | Description |
|--------|------|----------|---------|-------------|
| `api_key` | string | Yes | - | Your Xendit secret API key |
| `webhook_token` | string | **Prod: Yes**<br>Dev: No | - | Webhook verification token - **REQUIRED for production** to verify webhook authenticity and prevent attacks |
| `api_url` | string | No | `https://api.xendit.co` | Xendit API base URL |
| `default_country` | string | No | `ID` | Default country code for payments |
| `default_capture_method` | string | No | `AUTOMATIC` | Payment capture method (`AUTOMATIC` or `MANUAL`) |

## Webhook Setup

Webhooks are essential for receiving real-time payment status updates from Xendit.

### 1. Configure Webhook URL in Xendit Dashboard

1. Go to [Xendit Dashboard](https://dashboard.xendit.co/settings/developers#webhooks)
2. Add your webhook URL:
   ```
   https://your-domain.com/hooks/payment/xendit
   ```
3. Select the following events:
   - `payment.capture`
   - `payment.failed`
4. Copy the **Callback Token** and add it to your `.env` as `XENDIT_WEBHOOK_TOKEN`

### 2. Webhook Verification (Security)

**IMPORTANT**: Xendit strongly recommends webhook verification to prevent man-in-the-middle attacks and money loss incidents.

The plugin automatically verifies incoming webhooks using the `x-callback-token` header when you configure `XENDIT_WEBHOOK_TOKEN`:

- **With token**: Webhooks are verified against the token. Unauthorized requests are rejected with 401.
- **Without token**: Webhooks are accepted but a security warning is logged. **Not recommended for production**.

**How it works:**
1. Xendit includes an `x-callback-token` header in each webhook request
2. The plugin compares this token with your configured `XENDIT_WEBHOOK_TOKEN`
3. Only webhooks with matching tokens are processed
4. This ensures webhooks are actually from Xendit, not malicious third parties

Reference: [Xendit Webhook Security Best Practices](https://docs.xendit.co/docs/handling-webhooks)

## Supported Payment Methods

When using Payment Links, customers are redirected to Xendit's hosted checkout page where they can choose from various payment methods enabled for your account. The available methods depend on your Xendit account configuration and may include:

### E-Wallets
- OVO
- DANA
- LinkAja
- ShopeePay
- JeniusPay
- AstraPay

### Virtual Accounts
- BCA
- BNI
- BRI
- Mandiri
- Permata
- BJB
- BSI
- CIMB

### QR Codes
- QRIS (Indonesian standard QR)

### Cards
- Credit Card
- Debit Card

### Retail Outlets
- Alfamart
- Indomaret

### Direct Debit
- BRI Direct Debit
- BCA KlikPay
- Mandiri Direct Debit

**Note:** The actual payment methods available to your customers depend on your Xendit account settings and the currencies/countries you support. Configure these in your [Xendit Dashboard](https://dashboard.xendit.co/).

## How It Works

This plugin uses **Xendit Payment Links** (invoices), which provides a hosted checkout experience:

1. **Create Payment Link**: When a customer initiates payment, the plugin creates a Xendit invoice via the `/v2/invoices` API endpoint
2. **Redirect to Xendit**: The customer is redirected to Xendit's secure hosted checkout page where they can select their preferred payment method
3. **Customer Completes Payment**: The customer completes payment on Xendit's platform
4. **Webhook Notification**: Xendit sends a webhook to your server with the payment status (PAID, EXPIRED, etc.)
5. **Order Completion**: The plugin processes the webhook and updates the order status accordingly

### Payment Flow Example

```typescript
// When customer proceeds to checkout with Xendit:
// 1. Medusa calls the Xendit provider to initiate payment
// 2. Plugin creates a Xendit invoice (Payment Link)
// 3. Customer is redirected to the invoice_url

// Example response structure:
{
  "invoice_url": "https://checkout.xendit.co/web/inv-xxxxx",
  "id": "inv-xxxxx",
  "external_id": "medusa_order_123",
  "status": "PENDING",
  "amount": 100000
}

// 4. Customer completes payment on Xendit's page
// 5. Xendit sends webhook to /hooks/payment/xendit
// 6. Plugin updates order status to paid
```

### Customizing Payment Methods

You can customize which payment methods are available on the Xendit checkout page by configuring the invoice creation. The plugin automatically handles the redirect flow and webhook processing.

## Testing

### Development Mode with Test Mode (Recommended for Local Development)

Enable test mode to simulate payments without needing webhooks to reach localhost:

```bash
# .env
XENDIT_SECRET_KEY=xnd_development_your_test_key_here
XENDIT_TEST_MODE=true
```

**Benefits:**
- No need for ngrok or webhook tunneling
- Manually simulate payment completion via API
- Perfect for local development
- Auto-detects test API keys

**Quick Usage:**
```bash
# 1. Create payment normally through your checkout
# 2. Get the invoice ID from logs or URL
# 3. Simulate payment completion:
curl -X POST http://localhost:9000/admin/xendit/simulate \
  -H "Content-Type: application/json" \
  -d '{"invoice_id": "YOUR_INVOICE_ID"}'
```

**Full Guide:** See [`docs/TEST_MODE_GUIDE.md`](../../docs/TEST_MODE_GUIDE.md)

### Production Testing with Webhooks

Use Xendit test credentials for development:

```bash
XENDIT_SECRET_KEY=xnd_development_your_test_key_here
XENDIT_TEST_MODE=false  # Disable simulation, use real webhooks
```

For webhook testing, use ngrok or similar:
```bash
ngrok http 9000
# Configure webhook URL in Xendit Dashboard
```

### Test Payment Scenarios

Xendit provides test credentials and scenarios for different payment methods:

- [Test Scenarios Documentation](https://docs.xendit.co/docs/en/test-scenarios)
- [Simulate Different Payment Outcomes](https://docs.xendit.co/docs/simulate-error-scenarios)

### Testing Webhooks Locally

For local development, use tools like:

- [ngrok](https://ngrok.com/) to expose your local server
- [localtunnel](https://localtunnel.github.io/www/) as an alternative
- Xendit Dashboard webhook simulator

Example with ngrok:

```bash
ngrok http 9000
# Use the HTTPS URL in Xendit Dashboard: https://xxxx.ngrok.io/hooks/payment/xendit
```

## Troubleshooting

### Webhook Not Receiving Events

1. **Check Webhook URL Configuration**
   - Verify the URL in Xendit Dashboard matches your deployment
   - Ensure the URL is publicly accessible (use ngrok for local testing)
   - URL format: `https://your-domain.com/hooks/payment/xendit`

2. **Verify Webhook Token**
   - Check `XENDIT_WEBHOOK_TOKEN` is set correctly
   - Token should match the one in Xendit Dashboard
   - Look for "SECURITY WARNING" in logs if token is missing

3. **Check Webhook Logs**
   - View webhook delivery status in Xendit Dashboard
   - Check your application logs for "Xendit webhook received" messages
   - Look for error responses (401, 400, 500)

### Payment Not Processing

1. **Check API Key**
   - Verify `XENDIT_SECRET_KEY` is correct
   - Ensure using the right environment (test vs production)
   - Check for "API_VALIDATION_ERROR" in logs

2. **Rate Limiting**
   - Default limits: 60 requests/min (test), 600 requests/min (live)
   - Check logs for "rate limit exceeded" messages
   - Implement exponential backoff for retries

3. **Payment Channel Issues**
   - Verify the channel is enabled in your Xendit account
   - Check minimum/maximum amounts for the channel
   - Ensure required channel properties are provided

### Common Error Codes

| Error Code | Description | Solution |
|------------|-------------|----------|
| `API_VALIDATION_ERROR` | Invalid API key or authentication | Check your `XENDIT_SECRET_KEY` |
| `CHANNEL_UNAVAILABLE` | Payment channel not available | Enable channel in Xendit Dashboard |
| `INVALID_AMOUNT` | Amount outside allowed range | Check min/max amounts for channel |
| `DUPLICATE_REQUEST` | Duplicate reference_id | Use unique reference IDs |

### Debug Mode

Enable detailed logging by setting log level:

```typescript
// In medusa-config.ts
export default defineConfig({
  projectConfig: {
    // ... other config
    logger: {
      level: "debug", // Enable debug logs
    },
  },
});
```

## Important Notes

### Payment Links vs Payment API

This plugin uses **Xendit Payment Links** (Invoice API - `/v2/invoices`), which provides:
- Hosted checkout page managed by Xendit
- Automatic payment method selection UI
- Lower integration complexity
- No need to handle individual payment channel implementations

If you need direct API integration with granular control over each payment channel, consider using Xendit's Payment API instead.

### Refunds

Payment Links (invoices) have limited refund capabilities. For full refund support, you may need to:
- Use Xendit's Payment API instead of Payment Links
- Handle refunds manually through the Xendit Dashboard
- Contact Xendit support for refund processing

Refer to [Xendit's refund documentation](https://docs.xendit.co/docs/refunds) for more details.

## Resources

- [Xendit Payment Links Documentation](https://docs.xendit.co/apidocs/payment-link)
- [Xendit Invoice API Reference](https://docs.xendit.co/apidocs/payment-link#create-invoice)
- [Xendit Webhook Guide](https://docs.xendit.co/docs/handling-webhooks)
- [Xendit Dashboard](https://dashboard.xendit.co/)
- [Medusa Documentation](https://docs.medusajs.com)
- [GitHub Repository](https://github.com/MuhamadAjiW/xendit-medusa)

## License

MIT

## Support

- [GitHub Issues](https://github.com/MuhamadAjiW/xendit-medusa/issues)
- [Medusa Discord](https://discord.gg/medusajs)

## Compatibility

This starter is compatible with versions >= 2.4.0 of `@medusajs/medusa`.

## Medusa Resources

Visit the [Quickstart Guide](https://docs.medusajs.com/learn/installation) to set up a server.

Visit the [Plugins documentation](https://docs.medusajs.com/learn/fundamentals/plugins) to learn more about plugins and how to create them.

Visit the [Docs](https://docs.medusajs.com/learn/installation#get-started) to learn more about our system requirements.

## What is Medusa

Medusa is a set of commerce modules and tools that allow you to build rich, reliable, and performant commerce applications without reinventing core commerce logic. The modules can be customized and used to build advanced ecommerce stores, marketplaces, or any product that needs foundational commerce primitives. All modules are open-source and freely available on npm.

Learn more about [Medusa’s architecture](https://docs.medusajs.com/learn/introduction/architecture) and [commerce modules](https://docs.medusajs.com/learn/fundamentals/modules/commerce-modules) in the Docs.

## Community & Contributions

The community and core team are available in [GitHub Discussions](https://github.com/medusajs/medusa/discussions), where you can ask for support, discuss roadmap, and share ideas.

Join our [Discord server](https://discord.com/invite/medusajs) to meet other community members.

## Other channels

- [GitHub Issues](https://github.com/medusajs/medusa/issues)
- [Twitter](https://twitter.com/medusajs)
- [LinkedIn](https://www.linkedin.com/company/medusajs)
- [Medusa Blog](https://medusajs.com/blog/)
